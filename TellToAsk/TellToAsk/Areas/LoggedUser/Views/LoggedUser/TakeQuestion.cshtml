@model TellToAsk.Areas.LoggedUser.Models.AnswerModel

@(Html.Kendo().Grid<TellToAsk.Areas.LoggedUser.Models.QuestionModel>()
    .Name("Grid")
    .Columns(columns =>
    {
        columns.Bound(p => p.QuestionId).Visible(false);
        columns.Bound(p => p.QuestionTitle).Title("Question").ClientTemplate(
        "#: QuestionTitle.length > 100 ? (QuestionTitle.substring(0, 100).concat('...')) : QuestionTitle #"
).Groupable(false);
        columns.Bound(p => p.Category.Name).Title("Category").Width("400px");

    })
    .Groupable()
    .Pageable()
    .Sortable()
     .Selectable()
    .Filterable()
     .Events(ev =>
        {
            ev.Change("showDetails");
        })
    .DataSource(dataSource => dataSource
    .Ajax()
        .Read(read => read.Action("GetTargetedQuestions", "LoggedUser")))
)


@*TO DO multiple kendo windows*@
@(Html.Kendo().Window().Name("Details")
    .Title("Answer Question")
    .Visible(false)
    .Modal(false)
    .Draggable(false)
    .Pinned(true)
    .Width(300)
    .Events(ev => ev.Activate("maximizeWindowOnLoad"))
    .Actions(actions => actions.Pin())                
)

<script type="text/x-kendo-template" id="template">

    <div id="details-container">
        <em class="break-word">#: QuestionText #</em>

        @using (Html.BeginForm("AnswerToQuestion", "LoggedUser"))
        {
           

          <div class="control-group">
            @*@Html.LabelFor(model => model.Comment, new { @class = "control-label" })*@
            <div class="controls">
                @Html.EditorFor(model => model.Comment)
                @Html.ValidationMessageFor(model => model.Comment, null, new { @class = "help-inline", id = "commentInPopUp" })
            </div>
        </div>
            
            if (Model.QuestionId == 0)
            {
                <input type="hidden" name="QuestionId" value="#= QuestionId #" />
            }
            else
            {
                <input type="hidden" name="QuestionId" value="@(Model.QuestionId)" />
            }
            
            <input type="button" id="cancel-answer" onclick="closeKWin()" class="btn btn-success" value="Cancel" />
            <input type="submit" class="btn btn-success" value="Answer" />
        }
    </div>
</script>

<script>
    $( document ).ready(function() {

        window.manageAnswerWindow = function manageAnswerWindow(questionModel) {
       
            var wnd = $("#Details").data("kendoWindow");
            $("#question-text-popup").html(questionModel);
            wnd.content(detailsTemplate(questionModel));
            wnd.maximize()
            wnd.open();
        };

        var val = @(Model.QuestionId);

        if (val != 0) {
            
            $.getJSON("GetQuestionById", { id: val}, function(questionModel) {
                window.manageAnswerWindow(questionModel);
            }); 
        }

       var detailsTemplate = kendo.template($("#template").html());

      
    });

    
    function maximizeWindowOnLoad() {
       $("#Details").data("kendoWindow");
    }
   
    function showDetails(e) {
        var grid = e.sender;
        var currentDataItem = grid.dataItem(this.select()).QuestionId;
       
       
        $.getJSON("GetQuestionById", { id: currentDataItem}, function(questionModel) {
            window.manageAnswerWindow(questionModel);
        }); 

       
    }
   
    function closeKWin(e) {
          
        var wnd = $("#Details").data("kendoWindow");

        $("#commentInPopUp").html("");

        
        wnd.close();
      
    }
</script>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
}
